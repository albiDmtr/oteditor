import{s as ee,e as te,a as ae,b as ne,d as T,k as E,n as W,i as se,l as Z,m as oe,o as ie,p as re}from"./scheduler.BNZeKrfj.js";import{S as ce,i as de}from"./index.D5VrrNi7.js";import{t as O}from"./stores.B04GNUkc.js";import{S as he,A as me,W as le,V as k,O as pe,P as we,a as ue,M as C,D as fe,B as q,T as ge,R as H,b as X,c as ye,C as V}from"./three.module.BaM-MH9J.js";function Me(z){let c,y;return{c(){c=te("canvas"),this.h()},l(h){c=ae(h,"CANVAS",{width:!0,height:!0,class:!0}),ne(c).forEach(T),this.h()},h(){E(c,"width",z[0]),E(c,"height",z[0]),E(c,"class",y=W(z[2]?"loaded":"loading")+" svelte-1cj7uuf")},m(h,l){se(h,c,l),z[5](c)},p(h,[l]){l&1&&E(c,"width",h[0]),l&1&&E(c,"height",h[0]),l&4&&y!==(y=W(h[2]?"loaded":"loading")+" svelte-1cj7uuf")&&E(c,"class",y)},i:Z,o:Z,d(h){h&&T(c),z[5](null)}}}let Y=34;function Se(z,c,y){let h;oe(z,O,t=>y(11,h=t));let{data:l}=c,{size:R=200}=c,_,f=null,j=!1;const M=new he,N=new me(16777215,1);M.add(N);const F=(t,p)=>{const g=new k().addVectors(t,p).multiplyScalar(.5),w=new k().subVectors(t,p);w.z=0;const u=w.length(),a=32,e=1,d=u,D=new q(a,d,e),m=new ge().load("../connection-texture.svg",()=>{I()});m.wrapS=H,m.wrapT=H,m.repeat.set(1,d/a*1.6);const o=new X({map:m,transparent:!0,opacity:.3,side:ye}),n=Math.atan2(w.y,w.x),r=new C(D,o);r.rotation.z=n+Math.PI/2,r.position.copy(g),M.add(r)},J=(t,p,g,w)=>{const u=new V(17,17,6,32),a=new X({color:4777410,transparent:!0}),e=new C(u,a);e.castShadow=!0,e.rotateX(Math.PI*(90/180)),e.position.x=p,e.position.y=g,e.position.z=w-3,e.name=t,M.add(e)},K=(t,p,g,w)=>{const u=new V(4,4,20,32),a=new X({color:0,transparent:!0}),e=new C(u,a);e.castShadow=!0,e.rotateX(Math.PI*(90/180)),e.position.x=p,e.position.y=g,e.position.z=w-10,e.name=t,M.add(e)},Q=(t,p,g,w)=>{const u=new V(18,18,7,32),a=new X({color:4777410,transparent:!0}),e=new C(u,a);e.castShadow=!0;const d=new q(4,8,7),D=S=>{const m=new C(d,a);m.position.set(19*Math.cos(S),19*Math.sin(S),0),m.rotateZ(S),e.add(m)};for(let S=0;S<8;S++)D(S*Math.PI/4);u.rotateX(Math.PI*(90/180)),e.position.x=p,e.position.y=g,e.position.z=w-3.5,e.name=t,M.add(e)},I=()=>{if(f&&h){f.canvas.width=R,f.canvas.height=R;let t=window.devicePixelRatio||1;h.setSize(f.canvas.width/t*2,f.canvas.height/t*2,!1),f.clearRect(0,0,f.canvas.width,f.canvas.height),h.render(M,G),f.drawImage(h.domElement,0,0,f.canvas.width,f.canvas.height),y(2,j=!0)}};let G,P=0,v=0,b=0;ie(()=>{if(!h){const o=new le({antialias:!0,alpha:!0});o.setPixelRatio(window.devicePixelRatio),o.shadowMap.enabled=!0,O.set(o)}const t=[],p=(o,n)=>{const r={};l.structure.filter(s=>s[0].split(".")[0]===n.name).forEach(s=>{r[s[0].split(".")[1]]=s[1].split(".")[0]}),n.elements.forEach(s=>{const x={...s,name:`${n.name}.${s.name}`};if(x.type==="GearElement"&&s.type==="GearElement"&&s.parent&&(x.parent=`${n.name}.${s.parent}`),o.push(x),r[s.name]){let L=l.components.find(i=>i.name===r[s.name]);L&&p(o,L)}})},g=l.structure.map(o=>o[0].split(".")[0]),w=l.structure.map(o=>o[1].split(".")[0]),u=l.components.filter(o=>g.includes(o.name)&&!w.includes(o.name));u.length>0?u.forEach(o=>{let n=[];p(n,o),t.push(n)}):l.components.forEach(o=>{let n=[];p(n,o),t.push(n)});let a=0;t.forEach(o=>{let n=0,r=0,s=0,x=new Map,L=new Map;o.forEach(i=>{i.type==="Disk"?(J(i.name,a+s,r,n),n-=6):i.type==="ShaftDiscrete"||i.type==="ShaftContinuous"?(K(i.name,a+s,r,n),n-=20):i.type==="GearElement"&&(i.parent&&x.get(i.parent)&&i.name!==i.parent?(x.set(i.name,x.get(i.parent)),r+=Y,x.get(i.name).endY=r,n=x.get(i.parent).z,r%(Y*2)!==0?s=Y/1.5:s=0,F(L.get(i.parent),new k(a+s,r,n-3.5))):x.set(i.name,{z:n,endY:r}),Q(i.name,a+s,r,n),L.set(i.name,new k(a+s,r,n-3.5)),n-=7),n<P&&(P=n),r>v&&(v=r),a+s>b&&(b=a+s)}),a+=80}),A(M,0,200,0,!0),A(M,100,200,200),A(M,-100,-200,-100);const d=70+Math.max(v*1.2,-P*.65,b*.9);G=new pe(-d/2,d/2,d/2,-d/2,.1,1e4);const D=new we(2e3,-P+12),S=new ue({opacity:.15}),m=new C(D,S);m.receiveShadow=!0,m.name="shadowPlane",m.rotation.x=-Math.PI/2,m.position.y=-21,m.position.z=P/2,M.add(m),B(),U(),window.addEventListener("resize",B),f=_.getContext("2d"),I()});const B=()=>{_&&G.updateProjectionMatrix()},A=(t,p,g,w,u=!1)=>{const a=new fe(16777215,1);a.position.set(p,g,w);const e=Math.max(v,-P,b+10);let d=12;u&&(a.castShadow=!0,a.shadow.camera.near=.05,a.shadow.camera.far=500,a.shadow.camera.left=-e-d,a.shadow.camera.right=e+d,a.shadow.camera.top=e+d,a.shadow.camera.bottom=-e-d,a.shadow.mapSize.width=(e+d)*5,a.shadow.mapSize.height=(e+d)*5,a.shadow.radius=d),t.add(a)},U=()=>{const t=Math.max(v,-P,b);G.position.set(7*t+b/2,8.5*t+v/2,8.8*t+P/2),G.lookAt(b/2,0,P/2),I()};function $(t){re[t?"unshift":"push"](()=>{_=t,y(1,_)})}return z.$$set=t=>{"data"in t&&y(3,l=t.data),"size"in t&&y(0,R=t.size)},[R,_,j,l,I,$]}class ve extends ce{constructor(c){super(),de(this,c,Se,Me,ee,{data:3,size:0,render:4})}get render(){return this.$$.ctx[4]}}export{ve as S};
